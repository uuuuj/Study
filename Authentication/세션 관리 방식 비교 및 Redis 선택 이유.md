# 세션 관리 방식 비교 및 Redis 선택 이유

## 개요

SSO 인증 + WebSocket 환경에서 세션 관리 방식을 검토하고, Redis를 선택한 이유를 정리한 문서입니다.

---

## 환경 및 요구사항

### 현재 인증 구조

```
1. WebSocket으로 SSO 인증 정보 수신
2. 수신된 사용자 정보를 DB에 저장
3. 세션에 일부 정보 저장
4. 이후 요청 시 세션에서 로그인 정보 조회
```

### 보안 요구사항

- 쿠키에 사용자 정보가 노출되면 안 됨
- 쿠키를 통해 사용자 정보를 볼 수 있으면 안 됨
- 필요 시 강제 로그아웃(세션 무효화) 가능해야 함
- 폐쇄망 환경에서 운영

---

## 세션 관리 방식 비교

### 저장 위치와 가시성

| 방식 | 저장 위치 | 사용자가 내용을 볼 수 있나? |
|-----|----------|--------------------------|
| Redis 세션 | 서버 메모리 | ❌ 못 봄 (session_id만 노출) |
| Signed Cookie | 브라우저 쿠키 | ✅ 볼 수 있음 |
| JWT | 브라우저 | ✅ 볼 수 있음 (Base64 디코딩) |

### 기본 동작 방식 차이

| 구분 | Redis 세션 | JWT / Signed Cookie |
|-----|-----------|---------------------|
| 기본 상태 | 무효 (Redis에 없으면 인증 실패) | 유효 (서명만 맞으면 인증 성공) |
| 만료 | Redis에서 삭제되면 즉시 무효 | 토큰 내 만료 시간까지 계속 유효 |
| 강제 무효화 | Redis에서 삭제하면 됨 | 불가능 (블랙리스트 필요) |

---

## Redis 세션을 선택한 이유

### 1. 사용자 정보 비노출

```
Redis 세션 방식
───────────────
클라이언트 쿠키: sessionid=abc123xyz
                      ↑
                 이것만 보임 (열쇠 역할)

서버 Redis: session:abc123xyz → {user_id, username, department, ...}
                                      ↑
                                 실제 데이터는 서버에
```

```
JWT / Signed Cookie 방식
────────────────────────
클라이언트에 저장: eyJ1c2VyX2lkIjoxMjMsInVzZXJuYW1lIjoieXVqZW9uZyJ9...
                        ↑
                  Base64 디코딩하면 내용이 보임

디코딩 결과: {"user_id": 123, "username": "yujeong", "department": "개발팀"}
```

### 2. 강제 로그아웃 가능

비밀번호 변경, 보안 이슈 발생 시 모든 기기에서 즉시 로그아웃 가능:

```python
# Redis 세션 - 즉시 무효화
for key in cache.keys(f"session:user:{user_id}:*"):
    cache.delete(key)
# 다음 요청부터 바로 인증 실패

# JWT - 불가능
# 이미 발급된 토큰은 만료 시간까지 계속 유효
# 블랙리스트를 쓰면 가능하지만, 결국 Redis를 써야 함
```

### 3. 토큰 탈취 시 대응

| 상황 | Redis 세션 | JWT |
|-----|-----------|-----|
| 토큰 탈취 감지 | 세션 삭제로 즉시 무효화 | 만료까지 유효 (대응 불가) |
| 피해 범위 | 서버에서 통제 가능 | 통제 불가 |

---

## JWT를 선택하지 않은 이유

### JWT 구조

```
eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxMjN9.XXXX
     ↑                    ↑                  ↑
   Header               Payload           Signature
   (알고리즘)          (실제 데이터)        (서명)
```

### 문제점

1. **데이터 노출**: Payload는 암호화가 아닌 Base64 인코딩이라 누구나 디코딩 가능
2. **강제 무효화 불가**: 서버에 상태를 저장하지 않아 발급된 토큰 무효화 불가
3. **블랙리스트 사용 시 의미 퇴색**: 강제 무효화를 위해 블랙리스트를 쓰면 결국 Redis 사용 → JWT의 stateless 장점 상실

### JWT가 적합한 경우

- MSA에서 서비스 간 인증
- 외부 API 토큰 발급
- 사용자 정보 노출돼도 상관없는 경우
- 강제 로그아웃이 필요 없는 경우

---

## Signed Cookie를 선택하지 않은 이유

### Signed Cookie 특징

- 서버가 서명한 쿠키로, 변조 감지 가능
- 하지만 **암호화가 아님** → 내용은 그대로 보임

```python
response.set_signed_cookie('user_id', '123', salt='my-salt')
# 브라우저에 저장: user_id=123:1j4k5h6:Xt7Yp9Kw2mN...
#                    ↑         ↑         ↑
#                   값      타임스탬프   서명
# 값(123)은 그대로 노출됨
```

### 한계

- 쿠키 용량 제한 (4KB)
- 사용자 정보가 그대로 노출
- 강제 무효화 불가

### 적합한 용도

```python
# 민감하지 않은 설정값
response.set_signed_cookie('theme', 'dark')
response.set_signed_cookie('language', 'ko')
```

---

## Memcached를 선택하지 않은 이유

### Redis vs Memcached

| 항목 | Redis | Memcached |
|-----|-------|-----------|
| 데이터 구조 | 다양 (list, set, hash 등) | 단순 키-값만 |
| 영속성 | 디스크 저장 가능 | 메모리만 (휘발성) |
| Pub/Sub | 지원 | 미지원 |
| 용도 | 캐시 + 세션 + 큐 + 실시간 통신 | 순수 캐시 |

### Redis 선택 이유

1. **Pub/Sub 지원**: WebSocket 환경에서 세션 무효화 이벤트 전파 가능
2. **다양한 데이터 구조**: 세션 외에도 다양한 용도로 활용 가능
3. **영속성 옵션**: 서버 재시작 시에도 세션 유지 가능

### Memcached가 적합한 경우

- 순수 캐시 용도 (DB 쿼리 결과 캐싱 등)
- Redis의 Fallback 용도

---

## 현재 구현 구조

```
┌─────────────────────────────────────────────────────────┐
│                      클라이언트                          │
│  쿠키: sessionid=abc123 (사용자 정보 없음)               │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    Django 서버                          │
│                                                         │
│  1. WebSocket으로 SSO 인증 정보 수신                     │
│  2. 사용자 정보 DB 저장                                  │
│  3. Redis 세션에 필요한 정보 저장                        │
│  4. 클라이언트에 session_id만 전달                       │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    Redis 서버                           │
│                                                         │
│  session:abc123 → {                                     │
│      "user_id": 123,                                    │
│      "username": "yujeong",                             │
│      "department": "개발팀",                             │
│      ...                                                │
│  }                                                      │
└─────────────────────────────────────────────────────────┘
```

---

## 결론

### 요구사항 충족 여부

| 요구사항 | Redis 세션 | JWT | Signed Cookie |
|---------|-----------|-----|---------------|
| 쿠키에 사용자 정보 비노출 | ✅ | ❌ | ❌ |
| 강제 로그아웃 가능 | ✅ | ❌ (블랙리스트 필요) | ❌ |
| 토큰 탈취 시 즉시 대응 | ✅ | ❌ | ❌ |
| SSO + WebSocket 연동 | ✅ | △ | △ |

### 최종 선택: Redis 세션

- **보안**: 사용자 정보가 서버에만 저장되어 노출 위험 없음
- **제어**: 필요 시 즉시 세션 무효화 가능
- **확장성**: Pub/Sub으로 다중 서버 환경에서 세션 이벤트 전파 가능
- **다용도**: 캐시, 큐, 실시간 통신 등 다양한 용도로 활용 가능